# project.js 処理内容説明書

## 概要

`project.js` は、MIXIのファイルサーバーヒアリングにおいて、projectフォルダに関するデータを処理するGoogle Apps Scriptです。主に以下の2つの処理を行います：

1. **回答シート作成処理**: 元データを確認先ごとに分割し、個別の回答用スプレッドシートを作成
2. **回答シートマージ処理**: 作成された各回答シートの内容を1つのシートに統合

---

## 設定定数

### シート名・ファイル名の設定

- `PROJECT_SOURCE_SHEET_NAME`: 元データが記載されているシート名（`'（新）project-2'`）
- `PROJECT_SUMMARY_SHEET_NAME`: 作成したシートのURL一覧を記載するシート名（`'project回答シートURL一覧'`）
- `PROJECT_EXCLUDED_SHEET_NAME`: ファイル数が0で除外されたデータをまとめるスプレッドシートのファイル名（`'project確認先を除外'`）
- `PROJECT_UNKNOWN_SHEET_NAME`: L列・M列が両方 '×' だった場合のファイル名（`'project不明'`）

### フォルダ設定

- `PROJECT_DESTINATION_FOLDER_ID`: 回答用スプレッドシートを保存するGoogle DriveフォルダのID

### 列インデックス定義

元データシート（`（新）project-2`）の各列に対応するインデックス：

- `PROJECT_COL_A_DIV1` (0): projectフォルダ_1階層目
- `PROJECT_COL_B_DIV2` (1): projectフォルダ 2階層目
- `PROJECT_COL_D_FOLDER_COUNT` (3): フォルダ数
- `PROJECT_COL_E_FILE_COUNT` (4): ファイル数
- `PROJECT_COL_F_DATA_SIZE` (5): データ容量/GB
- `PROJECT_COL_G_LAST_UPDATED` (6): 最終更新日
- `PROJECT_COL_H_HONBU` (7): 対象本部
- `PROJECT_COL_I_BUSHITSU` (8): 対象部室
- `PROJECT_COL_J_MIGRATION_DEST` (9): 移行先
- `PROJECT_COL_K_MIGRATION_METHOD` (10): 移行方法
- `PROJECT_COL_L_HONBUCHO` (11): 本部長
- `PROJECT_COL_M_BUSHITSUCHO` (12): 部室長

---

## 処理1: project_createResponseSheets() - 回答シート作成処理

### 処理の流れ

#### 1. 初期チェック
- `PROJECT_DESTINATION_FOLDER_ID` が設定されているか確認
- 元データシート（`（新）project-2`）が存在するか確認
- 指定されたGoogle Driveフォルダが存在するか確認

#### 2. データの読み込み
- 元データシートから全データを取得
- ヘッダー行を分離

#### 3. データの振り分け
各行に対して以下の処理を実行：

**a) ファイル数チェック**
- ファイル数が0または'0'の場合 → `excludedData` に追加（除外データとして扱う）

**b) 確認先の判定**
L列（本部長）とM列（部室長）の値に基づいて確認先を決定：
- L列が値あり、M列が'×' → L列の値を確認先とする
- L列が'×'、M列が値あり → M列の値を確認先とする
- L列・M列ともに値あり → M列の値を確認先とする（優先順位）
- L列・M列ともに'×' → `PROJECT_UNKNOWN_SHEET_NAME`（'project不明'）を確認先とする

**c) データの変換（v8修正）**
元データの列を以下のように再配置：
- G列（最終更新日）とH列（対象本部）の位置を入れ替え
- J列（移行先）とK列（移行方法）の位置を入れ替え
- ユーザー入力用の列（I, L, M, N, O列）を空値またはfalseで初期化

#### 4. 回答用シートの作成
確認先ごとに以下の処理を実行：

**a) スプレッドシートの作成**
- ファイル名: `(project) {確認先名}`
- 指定されたGoogle Driveフォルダに保存
- シート名を「回答」に設定

**b) ヘッダーの設定**
以下の15列のヘッダーを設定：
1. projectフォルダ_1階層目
2. projectフォルダ 2階層目
3. フォルダ数
4. ファイル数
5. データ容量/GB
6. 最終更新日
7. 対象本部 ※推測込
8. 対象部室 ※ 推測込
9. 回答者メールアドレス（ユーザー入力列）
10. 移行先（ユーザー入力列）
11. 移行方法（ユーザー入力列）
12. 共有ドライブ名（ユーザー入力列）
13. 個人情報有無（ユーザー入力列）
14. 自動化有無 ※スクリプトやRPAなど（ユーザー入力列）
15. その他（ユーザー入力列）

**c) フォーマット設定**
- ヘッダー行: 背景色 `#d9d9d9`、太字、枠線
- ユーザー入力列（I, J, K, L, M, N, O列）: 背景色 `#c9daf8` でハイライト
- データ行: 枠線を設定

**d) データバリデーション設定**
- J列（移行先）: `['Google Drive', 'AWS S3', '別テナント', '不要']` から選択
- K列（移行方法）: `['自対応', 'hatakan依頼', '不要']` から選択
- M列（個人情報有無）: チェックボックス
- N列（自動化有無）: チェックボックス

#### 5. 除外データシートの作成
ファイル数が0のデータがある場合、`PROJECT_EXCLUDED_SHEET_NAME`（'project確認先を除外'）という名前でスプレッドシートを作成し、同様のフォーマットを適用

#### 6. URL一覧シートの更新
`project回答シートURL一覧` シートに以下を記録：
- 確認先氏名
- SpreadsheetのURL
- 件数

#### 7. 完了通知
処理完了をユーザーに通知

---

## 処理2: project_createAndFormatSheet() - ヘルパー関数

### 役割
個別のスプレッドシートを作成し、フォーマットを適用する内部関数

### 処理の流れ

1. **スプレッドシートの作成**
   - 新しいスプレッドシートを作成
   - 指定されたフォルダに移動
   - ルートフォルダから削除

2. **シートの初期化**
   - シート名を「回答」に設定
   - 不要な行・列を削除（データ行数+1行、ヘッダー列数分のみ残す）

3. **ヘッダーの設定**
   - ヘッダー行に値を設定
   - 背景色、太字、枠線を適用
   - ユーザー入力列をハイライト

4. **データの書き込み**
   - データ行を書き込み
   - 枠線を設定
   - データバリデーションを適用

5. **列幅の自動調整**
   - 全列の幅を自動調整

6. **戻り値**
   - スプレッドシートのURLと行数を返す

---

## 処理3: project_mergeResponseSheets() - 回答シートマージ処理

### 処理の流れ

#### 1. 初期チェック
- `project回答シートURL一覧` シートが存在するか確認

#### 2. URL一覧の読み込み
- URL一覧シートから2行目以降のデータを取得
- 各データには「確認先氏名」「SpreadsheetのURL」「件数」が含まれる

#### 3. 各回答シートの読み込みとマージ
各URLに対して以下の処理を実行：

**a) URLの検証**
- URLが有効（httpで始まる）か確認
- 無効な場合はスキップ

**b) スプレッドシートの読み込み**
- URLからスプレッドシートを開く
- 最初のシート（「回答」シート）の全データを取得

**c) データのマージ**
- 最初のシートからヘッダーを取得し、「確認先」列を先頭に追加
- 2行目以降のデータ行に「確認先氏名」を先頭に追加してマージ配列に追加

**d) エラーハンドリング**
- シートの読み込みに失敗した場合、エラーメッセージを含む行を追加

#### 4. マージ済みシートの作成
- `projectマージ済み回答` という名前のシートを作成（既存の場合はクリア）
- マージしたデータを書き込み
- 列幅を自動調整
- 1行目を固定（`setFrozenRows(1)`）
- ヘッダー行を太字に設定

#### 5. 完了通知
処理完了をユーザーに通知

---

## データ変換の詳細（v8修正）

元データから回答用シートへの列マッピング：

| 元データ列 | 元データ内容 | 回答用シート列 | 回答用シート内容 |
|----------|------------|--------------|----------------|
| A (0) | projectフォルダ_1階層目 | A (0) | projectフォルダ_1階層目 |
| B (1) | projectフォルダ 2階層目 | B (1) | projectフォルダ 2階層目 |
| D (3) | フォルダ数 | C (2) | フォルダ数 |
| E (4) | ファイル数 | D (3) | ファイル数 |
| F (5) | データ容量/GB | E (4) | データ容量/GB |
| G (6) | 最終更新日 | F (5) | 最終更新日 |
| **J (9)** | **移行先** | **G (6)** | **対象本部 ※推測込** |
| **K (10)** | **移行方法** | **H (7)** | **対象部室 ※ 推測込** |
| - | - | I (8) | 回答者メールアドレス（空） |
| **H (7)** | **対象本部** | **J (9)** | **移行先** |
| **I (8)** | **対象部室** | **K (10)** | **移行方法** |
| - | - | L (11) | 共有ドライブ名（空） |
| - | - | M (12) | 個人情報有無（false） |
| - | - | N (13) | 自動化有無（false） |
| - | - | O (14) | その他（空） |

**注意**: G/H列とJ/K列の値が入れ替わっています（v8修正）。

---

## エラーハンドリング

### project_createResponseSheets()
- フォルダID未設定時のアラート
- 元データシート不存在時のアラート
- フォルダ不存在時のアラート
- 個別シート作成失敗時のログ記録（処理は継続）

### project_mergeResponseSheets()
- URL一覧シート不存在時のアラート
- 無効なURLのスキップ
- シート読み込み失敗時のエラーログとエラー行の追加
- マージデータなし時のアラート

---

## ログ出力

処理の各段階で `Logger.log()` を使用してログを出力：
- 処理開始時のデータ件数
- データ振り分け完了時の確認先数・除外数
- 各シート作成開始・完了時の情報
- マージ処理時の各シートの処理状況

---

## 使用例

### 回答シート作成処理の実行
1. Googleスプレッドシートを開く
2. 「GAS実行メニュー」→「project フォルダ処理」→「回答シート作成」を選択
3. 処理が完了すると、指定フォルダに各確認先ごとのスプレッドシートが作成される
4. `project回答シートURL一覧` シートにURL一覧が記録される

### 回答シートマージ処理の実行
1. 各確認先が回答シートに入力完了した後
2. 「GAS実行メニュー」→「project フォルダ処理」→「回答シートマージ」を選択
3. 処理が完了すると、`projectマージ済み回答` シートに全回答が統合される

